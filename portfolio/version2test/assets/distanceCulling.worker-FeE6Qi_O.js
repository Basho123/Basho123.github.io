(function(){"use strict";const w=new Map;function z(M,t,o){const s=t.subarray(0,o);self.postMessage({id:M,indices:s},[t.buffer])}self.onmessage=M=>{const t=M.data;if(t.type==="init"){w.set(t.key,{matrices:new Float32Array(t.sab),count:t.count}),self.postMessage({type:"inited",key:t.key});return}if(t.type==="setCount"){const o=w.get(t.key);o&&(o.count=t.count);return}if(t.type==="distance"){const o=w.get(t.key);if(!o)return z(t.id,new Uint32Array(0),0);const s=o.matrices,d=o.count|0,[r,b,f]=t.camPos,i=t.indices&&t.indices.length>0?t.indices:null,y=i?i.length:d,p=new Uint32Array(y);let h=0;if(i)for(let c=0;c<i.length;c++){const a=i[c];if(a>=d)continue;const l=a*16,g=s[l+12],m=s[l+13],u=s[l+14],e=g-r,n=m-b,x=u-f;e*e+n*n+x*x<t.maxDistSq&&(p[h++]=a)}else for(let c=0;c<d;c++){const a=c*16,l=s[a+12],g=s[a+13],m=s[a+14],u=l-r,e=g-b,n=m-f;u*u+e*e+n*n<t.maxDistSq&&(p[h++]=c)}return z(t.id,p,h)}if(t.type==="frustum"){const o=w.get(t.key);if(!o)return z(t.id,new Uint32Array(0),0);const s=o.matrices,d=o.count|0,r=t.indices&&t.indices.length>0?t.indices:null,b=r?r.length:d,f=new Uint32Array(b);let i=0;const y=t.planes,p=t.sphereCenterLocal[0],h=t.sphereCenterLocal[1],c=t.sphereCenterLocal[2],a=t.sphereRadius,l=t.boundsPadding,g=t.planePadding,m=t.meshHideOffsetY,u=e=>{const n=e*16,x=Math.hypot(s[n+0],s[n+1],s[n+2]),L=Math.hypot(s[n+4],s[n+5],s[n+6]),A=Math.hypot(s[n+8],s[n+9],s[n+10]),P=s[n+12]+p*x,U=s[n+13]+h*L-m,S=s[n+14]+c*A,q=Math.max(x,L,A),D=a*q+l;for(let k=0;k<6;k++){const C=k*4,H=y[C+0],I=y[C+1],O=y[C+2],R=y[C+3];if(H*P+I*U+O*S+R<-D-g)return!1}return!0};if(r)for(let e=0;e<r.length;e++){const n=r[e];n>=d||u(n)&&(f[i++]=n)}else for(let e=0;e<d;e++)u(e)&&(f[i++]=e);return z(t.id,f,i)}}})();
